@using SDL.Models
@using MudBlazor

<MudDialog Class="video-player-dialog">
    <DialogContent>
        <MudStack Spacing="3">
            <MudText Typo="Typo.h6" Class="video-title">@Video?.Title</MudText>

            @if (Video != null)
            {
                <video controls class="video-player" style="width: 100%; max-height: 70vh; background-color: black;">
                    <source src="@GetVideoUrl()" type="@GetMimeType()">
                    Your browser does not support the video tag.
                </video>

                <MudStack Spacing="1" Class="video-info">
                    <MudText Typo="Typo.body2">
                        <strong>File:</strong> @Video.FileName
                    </MudText>
                    <MudText Typo="Typo.body2">
                        <strong>Size:</strong> @Video.FileSizeFormatted
                    </MudText>
                    <MudText Typo="Typo.body2">
                        <strong>Archived:</strong> @Video.ArchivedAt.ToString("yyyy-MM-dd HH:mm:ss")
                    </MudText>
                    @if (!string.IsNullOrEmpty(Video.Duration))
                    {
                        <MudText Typo="Typo.body2">
                            <strong>Duration:</strong> @Video.Duration
                        </MudText>
                    }
                    @if (!string.IsNullOrEmpty(Video.Uploader))
                    {
                        <MudText Typo="Typo.body2">
                            <strong>Uploader:</strong> @Video.Uploader
                        </MudText>
                    }
                    <MudText Typo="Typo.body2" Class="video-url">
                        <strong>Original URL:</strong>
                        <MudLink Href="@Video.OriginalUrl" Target="_blank">@Video.OriginalUrl</MudLink>
                    </MudText>
                </MudStack>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

<style>
    @@media (max-width: 768px) {
        .video-player-dialog {
            max-width: 100vw !important;
            margin: 0 !important;
        }

        .video-player {
            max-height: 50vh !important;
        }

        .video-title {
            font-size: 1rem !important;
            word-break: break-word;
        }

        .video-info {
            font-size: 0.75rem !important;
            max-height: 200px;
            overflow-y: auto;
        }

        .video-url {
            word-break: break-all;
        }
    }

    @@media (max-width: 480px) {
        .video-player {
            max-height: 40vh !important;
        }

        .video-title {
            font-size: 0.9rem !important;
        }

        .video-info .mud-typography {
            font-size: 0.7rem !important;
        }
    }
</style>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public ArchivedVideo? Video { get; set; }

    [Inject]
    private IFileSystemService FileSystem { get; set; } = default!;

    private string GetVideoUrl()
    {
        if (Video == null)
            return string.Empty;

        // Determine the directory based on file path
        var fileName = Video.FileName;

        // If the file path contains "converted", serve from converted directory
        if (Video.FilePath.Contains("converted", StringComparison.OrdinalIgnoreCase))
        {
            return $"/converted/{fileName}";
        }

        // Otherwise serve from archives directory
        return $"/archives/{fileName}";
    }

    private string GetMimeType()
    {
        if (Video == null)
            return "video/mp4";

        var extension = FileSystem.GetExtension(Video.FileName).ToLowerInvariant();
        return extension switch
        {
            ".webm" => "video/webm",
            ".mp4" => "video/mp4",
            ".mkv" => "video/x-matroska",
            ".avi" => "video/x-msvideo",
            _ => "video/mp4"
        };
    }

    private void Close()
    {
        MudDialog?.Close();
    }
}
